<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aritz Adin">

<title>Workshop on Areal Data - Section 2: CAR models for spatial disease mapping</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Workshop on Areal Data</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Workshop</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Section1.html" rel="" target="">
 <span class="menu-text">Installing bigDM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./Section2.html" rel="" target="" aria-current="page">
 <span class="menu-text">Spatial models</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Section3.html" rel="" target="">
 <span class="menu-text">Multivariate models</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Section4.html" rel="" target="">
 <span class="menu-text">Spatio-temporal models</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-car_inla-function" id="toc-the-car_inla-function" class="nav-link active" data-scroll-target="#the-car_inla-function">The <code>CAR_INLA()</code> function</a>
  <ul class="collapse">
  <li><a href="#main-input-arguments" id="toc-main-input-arguments" class="nav-link" data-scroll-target="#main-input-arguments">Main input arguments</a></li>
  </ul></li>
  <li><a href="#example-1-stomach-cancer-mortality-data" id="toc-example-1-stomach-cancer-mortality-data" class="nav-link" data-scroll-target="#example-1-stomach-cancer-mortality-data">Example 1: stomach cancer mortality data</a>
  <ul class="collapse">
  <li><a href="#global-model" id="toc-global-model" class="nav-link" data-scroll-target="#global-model">Global model</a></li>
  <li><a href="#partition-models" id="toc-partition-models" class="nav-link" data-scroll-target="#partition-models">Partition models</a></li>
  <li><a href="#compare-the-results" id="toc-compare-the-results" class="nav-link" data-scroll-target="#compare-the-results">Compare the results</a></li>
  </ul></li>
  <li><a href="#example-2-ecological-regression-model" id="toc-example-2-ecological-regression-model" class="nav-link" data-scroll-target="#example-2-ecological-regression-model">Example 2: ecological regression model</a>
  <ul class="collapse">
  <li><a href="#local-and-global-estimates-of-the-fixed-effects" id="toc-local-and-global-estimates-of-the-fixed-effects" class="nav-link" data-scroll-target="#local-and-global-estimates-of-the-fixed-effects">Local and global estimates of the fixed effects</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Section 2: CAR models for spatial disease mapping</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Aritz Adin </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Jun 27, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>This lab session focuses on how to use the <code>bigDM</code> package to fit the scalable spatial model’s proposals described in <a href="https://doi.org/10.1016/j.spasta.2021.100496">Orozco-Acosta et al.&nbsp;(2021)</a> using simulated mortality data from the municipalities of continental Spain.</p>
<section id="the-car_inla-function" class="level2">
<h2 class="anchored" data-anchor-id="the-car_inla-function">The <code>CAR_INLA()</code> function</h2>
<p>This function allows fitting (scalable) spatial Poisson mixed models to areal count data, where several conditional autoregressive (CAR) prior distributions can be specified for the spatial random effects.</p>
<p>Specifically, the linear predictor is modelled as</p>
<span class="math display">\[\begin{equation}
\log r_{i} = \beta_0 + {\bf x}_{i}^{'}\mathbf{\beta} + \xi_i, \quad \mbox{for} \quad i=1,\ldots,I
\end{equation}\]</span>
<p>where <span class="math inline">\(\beta_0\)</span> is a global intercept, <span class="math inline">\({\bf x}_{i}^{'}=(x_{i1},\ldots,x_{ip})\)</span> is a <span class="math inline">\(p\)</span>-vector of standardized covariates in the <span class="math inline">\(i\)</span>-th area, <span class="math inline">\(\mathbf{\beta}=(\beta_1,\ldots,\beta_p)^{'}\)</span> is the <span class="math inline">\(p\)</span>-vector of fixed effect coefficients, and <span class="math inline">\(\xi_i\)</span> is a spatially structured random effect with a CAR prior distribution.</p>
<section id="main-input-arguments" class="level3">
<h3 class="anchored" data-anchor-id="main-input-arguments">Main input arguments</h3>
<p>What follows is a brief description of the main input arguments and functionalities of the <code>CAR_INLA()</code> function:</p>
<ul>
<li><p><strong><code>carto</code></strong>: object of class <code>sf</code> or <code>SpatialPolygonsDataFrame</code> that contains the data of analysis and its associated cartography file. This object must contain at least the target variables of interest specified in the arguments <code>ID.area</code>, <code>O</code> and <code>E</code>.</p></li>
<li><p><strong><code>ID.area</code></strong>: character; name of the variable that contains the IDs of spatial areal units.</p></li>
<li><p><strong><code>ID.group</code></strong>: character; name of the variable that contains the IDs of the spatial partition (grouping variable). Only required if <code>model="partition"</code>.</p></li>
<li><p><strong><code>O</code></strong>: character; name of the variable that contains the observed number of disease cases for each areal units.</p></li>
<li><p><strong><code>E</code></strong>: character; name of the variable that contains either the expected number of disease cases or the population at risk for each areal unit.</p></li>
<li><p><strong><code>X</code></strong>: a character vector containing the names of the covariates within the <code>carto</code> object to be included in the model as fixed effects, or a matrix object playing the role of the fixed effects design matrix. If <code>X=NULL</code> (default), only a global intercept is included in the model as fixed effect.</p></li>
<li><p><strong><code>W</code></strong>: optional argument with the binary adjacency matrix of the spatial areal units. If <code>NULL</code> (default), this object is computed from the <code>carto</code> argument (two areas are considered as neighbours if they share a common border).</p></li>
<li><p><strong><code>prior</code></strong>: one of either <code>"Leroux"</code> (default), <code>"intrinsic"</code>, <code>"BYM"</code> or <code>"BYM2"</code>, which specifies the prior distribution considered for the spatial random effect.</p></li>
<li><p><strong><code>model</code></strong>: one of either <code>"global"</code> or <code>"partition"</code> (default), which specifies the Global model or one of the scalable model proposal’s (<em>Disjoint model</em> and <em>k-order neighbourhood model</em>, respectively).</p></li>
<li><p><strong><code>k</code></strong>: numeric value with the neighbourhood order used for the partition model. Usually k=2 or 3 is enough to get good results. If <code>k=0</code> (default) the Disjoint model is considered. Only required if <code>model="partition"</code>.</p></li>
<li><p><strong><code>compute.DIC</code></strong>: logical value; if <code>TRUE</code> (default) then approximate values of the Deviance Information Criterion (DIC) and Watanabe-Akaike Information Criterion (WAIC) are computed.</p></li>
<li><p><strong><code>compute.fitted.values</code></strong>: logical value (default <code>FALSE</code>); if <code>TRUE</code> transforms the posterior marginal distribution of the linear predictor to the exponential scale (risks or rates).</p></li>
<li><p><strong><code>inla.mode</code></strong>: one of either <code>"classic"</code> (default) or <code>"compact"</code>, which specifies the approximation method used by INLA. See <code>help(inla)</code> for further details.</p></li>
</ul>
<p>For further details, please refer to the <a href="https://cran.r-project.org/web/packages/bigDM/bigDM.pdf">reference manual</a> and the <a href="https://github.com/spatialstatisticsupna/bigDM/tree/master?tab=readme-ov-file#basic-use">vignettes</a> accompanying this package.</p>
</section>
</section>
<section id="example-1-stomach-cancer-mortality-data" class="level2">
<h2 class="anchored" data-anchor-id="example-1-stomach-cancer-mortality-data">Example 1: stomach cancer mortality data</h2>
<p>The main input argument of the <code>CAR_INLA()</code> function must be an object of class <code>sf</code> (simple feature) or <code>SpatialPolygonsDataFrame</code> that contains the data of analysis and its associated cartography file. Standard .shp files (shapefiles) can be loaded as <code>sf</code> objects in R using the <code>sf::st_read()</code> function.</p>
<p>Note that <strong>bigDM</strong> includes the <code>Carto_SpainMUN</code> object with the polygons of Spanish municipalities and simulated colorectal cancer mortality data (modified in order to preserve the confidentiality of the original data).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bigDM)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Cargando paquete requerido: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Cargando paquete requerido: sp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is INLA_24.05.10 built 2024-05-10 19:59:04 UTC.
 - See www.r-inla.org/contact-us for how to get help.
 - List available models/likelihoods/etc with inla.list.models()
 - Use inla.doc(&lt;NAME&gt;) to access documentation</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Breaking News: tmap 3.x is retiring. Please test v4, e.g. with
remotes::install_github('r-tmap/tmap')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Carto_SpainMUN"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Carto_SpainMUN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 8 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 485318 ymin: 4727428 xmax: 543317 ymax: 4779153
Projected CRS: ETRS89 / UTM zone 30N
     ID                                    name           area    perimeter obs
1 01001                        Alegria-Dulantzi 19913794 [m^2] 34372.11 [m]   2
2 01002                                 Amurrio 96145595 [m^2] 63352.32 [m]  28
3 01003                                 Aramaio 73338806 [m^2] 41430.46 [m]   6
4 01004                              Artziniega 27506468 [m^2] 22605.22 [m]   3
5 01006                                 Arminon 10559721 [m^2] 17847.35 [m]   0
6 01008 Arrazua-Ubarrundia (San Martin de Ania) 57502811 [m^2] 64968.81 [m]   2
         exp       SMR     region                       geometry
1  3.0237149 0.6614380 Pais Vasco MULTIPOLYGON (((538259 4737...
2 20.8456682 1.3432047 Pais Vasco MULTIPOLYGON (((503520 4760...
3  3.7527301 1.5988360 Pais Vasco MULTIPOLYGON (((533286 4759...
4  3.2093191 0.9347777 Pais Vasco MULTIPOLYGON (((491260 4776...
5  0.4817391 0.0000000 Pais Vasco MULTIPOLYGON (((509851 4727...
6  1.9643891 1.0181282 Pais Vasco MULTIPOLYGON (((534678 4746...</code></pre>
</div>
</div>
<section id="global-model" class="level3">
<h3 class="anchored" data-anchor-id="global-model">Global model</h3>
<p>We start by fitting the <em>Global model</em> described in Equation (1), where the entire neighbourhood graph of the areal units (municipalities) is considered to define the adjacency matrix <span class="math inline">\({\bf W}\)</span>.</p>
<p>The <code>connect_subgraphs()</code> function computes a fully connected graph and its associated adjacency matrix by merging disjoint connected subgraphs through its nearest polygon centroids.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="al">NOTE</span><span class="do">: Not necessary (shown for illustrative purposes only)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>aux <span class="ot">&lt;-</span> <span class="fu">connect_subgraphs</span>(Carto_SpainMUN, <span class="at">ID.area=</span><span class="st">"ID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for isolated areas:
  1 region(s) with no links

Searching for disjoint connected subgraphs:
 No disjoint connected subgraphs</code></pre>
</div>
</div>
<p>The function returns a list with the following two elements: * nb: the modified neighbours list * W: associated spatial adjacency matrix of class <code>dgCMatrix</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(aux,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ nb:List of 7907
  ..- attr(*, "class")= chr "nb"
  ..- attr(*, "region.id")= chr [1:7907] "1" "2" "3" "4" ...
  ..- attr(*, "call")= language spdep::poly2nb(pl = carto)
  ..- attr(*, "type")= chr "queen"
  ..- attr(*, "sym")= logi TRUE
 $ W :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(aux<span class="sc">$</span>nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 7907 
Number of nonzero links: 47532 
Percentage nonzero weights: 0.07602608 
Average number of links: 6.011382 
Link number distribution:

   1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16 
  53  169  522 1149 1721 1631 1112  680  378  199  106   60   34   24   18   13 
  17   18   19   20   21   23   24   25   27   28   31   32   33   34   39 
  11    2    5    3    4    2    2    2    1    1    1    1    1    1    1 
53 least connected regions:
244 256 549 630 637 650 667 715 760 1000 1315 1479 1484 1528 1610 1696 1706 1837 1853 1876 1936 2061 2069 2070 2310 2324 2454 2492 2724 4287 4381 4466 4493 4502 4525 4905 5154 5155 5312 5614 6074 6075 6472 6477 6839 6855 6890 7293 7335 7502 7572 7700 7766 with 1 link
1 most connected region:
2196 with 39 links</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>aux<span class="sc">$</span>W[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10 x 10 sparse Matrix of class "dgCMatrix"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  [[ suppressing 10 column names '1', '2', '3' ... ]]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                      
1  . . . . . . . . . 1
2  . . . . . . . 1 . .
3  . . . . . . . . . .
4  . . . . . . . 1 . .
5  . . . . . . . . . .
6  . . . . . . . . . .
7  . . . . . . . . . .
8  . 1 . 1 . . . . . .
9  . . . . . . . . . .
10 1 . . . . . . . . .</code></pre>
</div>
</div>
<p>The <em>Global model</em> with an iCAR/BYM2 prior distribution are fitted using the <code>CAR_INLA()</code> function as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit the models</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>iCAR.Global <span class="ot">&lt;-</span> <span class="fu">CAR_INLA</span>(<span class="at">carto=</span>Carto_SpainMUN, <span class="at">ID.area=</span><span class="st">"ID"</span>, <span class="at">O=</span><span class="st">"obs"</span>, <span class="at">E=</span><span class="st">"exp"</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">model=</span><span class="st">"global"</span>, <span class="at">prior=</span><span class="st">"intrinsic"</span>, <span class="at">inla.mode=</span><span class="st">"compact"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>STEP 1: Pre-processing data
STEP 2: Fitting global model with INLA (this may take a while...)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(iCAR.Global)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time used:
    Pre = 3.37, Running = 4.96, Post = 1.46, Total = 9.78 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) -0.007 0.006     -0.019   -0.007      0.005 -0.007   0

Random effects:
  Name    Model
    ID.area Besags ICAR model

Model hyperparameters:
                       mean   sd 0.025quant 0.5quant 0.975quant  mode
Precision for ID.area 39.53 5.45      30.18    39.06      51.48 38.17

Deviance Information Criterion (DIC) ...............: 27429.73
Deviance Information Criterion (DIC, saturated) ....: 8363.46
Effective number of parameters .....................: 342.12

Watanabe-Akaike information criterion (WAIC) ...: 27430.14
Effective number of parameters .................: 301.19

Marginal log-Likelihood:  -19904.61 
CPO, PIT is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>BYM2.Global <span class="ot">&lt;-</span> <span class="fu">CAR_INLA</span>(<span class="at">carto=</span>Carto_SpainMUN, <span class="at">ID.area=</span><span class="st">"ID"</span>, <span class="at">O=</span><span class="st">"obs"</span>, <span class="at">E=</span><span class="st">"exp"</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">model=</span><span class="st">"global"</span>, <span class="at">prior=</span><span class="st">"BYM2"</span>, <span class="at">inla.mode=</span><span class="st">"compact"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>STEP 1: Pre-processing data
STEP 2: Fitting global model with INLA (this may take a while...)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BYM2.Global)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time used:
    Pre = 3.15, Running = 15.1, Post = 2.34, Total = 20.6 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) -0.009 0.006     -0.021   -0.009      0.003 -0.009   0

Random effects:
  Name    Model
    ID.area BYM2 model

Model hyperparameters:
                        mean    sd 0.025quant 0.5quant 0.975quant   mode
Precision for ID.area 73.032 9.618     56.020   72.377     93.824 71.029
Phi for ID.area        0.831 0.072      0.665    0.841      0.943  0.863

Deviance Information Criterion (DIC) ...............: 27426.29
Deviance Information Criterion (DIC, saturated) ....: 8360.03
Effective number of parameters .....................: 376.91

Watanabe-Akaike information criterion (WAIC) ...: 27414.59
Effective number of parameters .................: 320.52

Marginal log-Likelihood:  -10466.86 
CPO, PIT is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model comparison</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>compare.DIC <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">mean.deviance=</span>x<span class="sc">$</span>dic<span class="sc">$</span>mean.deviance, <span class="at">p.eff=</span>x<span class="sc">$</span>dic<span class="sc">$</span>p.eff,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">DIC=</span>x<span class="sc">$</span>dic<span class="sc">$</span>dic, <span class="at">WAIC=</span>x<span class="sc">$</span>waic<span class="sc">$</span>waic,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">time=</span>x<span class="sc">$</span>cpu.used[<span class="st">"Total"</span>])</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">do.call</span>(rbind,<span class="fu">lapply</span>(<span class="fu">list</span>(<span class="at">iCAR=</span>iCAR.Global, <span class="at">BYM2=</span>BYM2.Global), compare.DIC))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mean.deviance    p.eff      DIC     WAIC      time
iCAR      27087.61 342.1213 27429.73 27430.14  9.779073
BYM2      27049.38 376.9107 27426.30 27414.59 20.596519</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(iCAR.Global<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0.5quant</span><span class="st">`</span>,</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>     BYM2.Global<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0.5quant</span><span class="st">`</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"iCAR model"</span>, <span class="at">ylab=</span><span class="st">"BYM2 model"</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"Posterior median estimates"</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>),<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Section2_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="partition-models" class="level3">
<h3 class="anchored" data-anchor-id="partition-models">Partition models</h3>
<p>A natural choice for defining the partition of the entire spatial domain could be using administrative subdivisions, such as provinces or states. For our example data, the <span class="math inline">\(D=15\)</span> Autonomous Regions of Spain are used as a partition of the <span class="math inline">\(n=7907\)</span> municipalities (<code>Carto_SpainMUN$region</code> variable).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(Carto_SpainMUN) <span class="sc">+</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col=</span><span class="st">"region"</span>) <span class="sc">+</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.outside=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Section2_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The <em>disjoint</em> and <em>k-order neighbourhood models</em> with an iCAR prior distribution are fitted using the <code>CAR_INLA()</code> function as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>iCAR.k0 <span class="ot">&lt;-</span> <span class="fu">CAR_INLA</span>(<span class="at">carto=</span>Carto_SpainMUN, <span class="at">ID.area=</span><span class="st">"ID"</span>, <span class="at">O=</span><span class="st">"obs"</span>, <span class="at">E=</span><span class="st">"exp"</span>,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">model=</span><span class="st">"partition"</span>, <span class="at">k=</span><span class="dv">0</span>, <span class="at">ID.group=</span><span class="st">"region"</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior=</span><span class="st">"intrinsic"</span>, <span class="at">inla.mode=</span><span class="st">"compact"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>STEP 1: Pre-processing data
STEP 2: Fitting partition (k=0) model with INLA 
+ Model 1 of 15 
+ Model 2 of 15 
+ Model 3 of 15 
+ Model 4 of 15 
+ Model 5 of 15 
+ Model 6 of 15 
+ Model 7 of 15 
+ Model 8 of 15 
+ Model 9 of 15 
+ Model 10 of 15 
+ Model 11 of 15 
+ Model 12 of 15 
+ Model 13 of 15 
+ Model 14 of 15 
+ Model 15 of 15 
STEP 3: Merging the results</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>iCAR.k0<span class="sc">$</span>cpu.used</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Running  Merging    Total 
24.04738 20.36000 44.40738 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>iCAR.k1 <span class="ot">&lt;-</span> <span class="fu">CAR_INLA</span>(<span class="at">carto=</span>Carto_SpainMUN, <span class="at">ID.area=</span><span class="st">"ID"</span>, <span class="at">O=</span><span class="st">"obs"</span>, <span class="at">E=</span><span class="st">"exp"</span>,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">model=</span><span class="st">"partition"</span>, <span class="at">k=</span><span class="dv">1</span>, <span class="at">ID.group=</span><span class="st">"region"</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior=</span><span class="st">"intrinsic"</span>, <span class="at">inla.mode=</span><span class="st">"compact"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>STEP 1: Pre-processing data
STEP 2: Fitting partition (k=1) model with INLA 
+ Model 1 of 15 
+ Model 2 of 15 
+ Model 3 of 15 
+ Model 4 of 15 
+ Model 5 of 15 
+ Model 6 of 15 
+ Model 7 of 15 
+ Model 8 of 15 
+ Model 9 of 15 
+ Model 10 of 15 
+ Model 11 of 15 
+ Model 12 of 15 
+ Model 13 of 15 
+ Model 14 of 15 
+ Model 15 of 15 
STEP 3: Merging the results</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>iCAR.k1<span class="sc">$</span>cpu.used</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Running  Merging    Total 
25.15934 25.67000 50.82934 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>iCAR.k2 <span class="ot">&lt;-</span> <span class="fu">CAR_INLA</span>(<span class="at">carto=</span>Carto_SpainMUN, <span class="at">ID.area=</span><span class="st">"ID"</span>, <span class="at">O=</span><span class="st">"obs"</span>, <span class="at">E=</span><span class="st">"exp"</span>,</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">model=</span><span class="st">"partition"</span>, <span class="at">k=</span><span class="dv">2</span>, <span class="at">ID.group=</span><span class="st">"region"</span>,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior=</span><span class="st">"intrinsic"</span>, <span class="at">inla.mode=</span><span class="st">"compact"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>STEP 1: Pre-processing data
STEP 2: Fitting partition (k=2) model with INLA 
+ Model 1 of 15 
+ Model 2 of 15 
+ Model 3 of 15 
+ Model 4 of 15 
+ Model 5 of 15 
+ Model 6 of 15 
+ Model 7 of 15 
+ Model 8 of 15 
+ Model 9 of 15 
+ Model 10 of 15 
+ Model 11 of 15 
+ Model 12 of 15 
+ Model 13 of 15 
+ Model 14 of 15 
+ Model 15 of 15 
STEP 3: Merging the results</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>iCAR.k2<span class="sc">$</span>cpu.used</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Running  Merging    Total 
25.95786 26.19000 52.14786 </code></pre>
</div>
</div>
<p>Internally, the <code>divide_carto()</code> function is called to compute the overlapping set of regions <span class="math inline">\(\{D_1,\ldots,D_{15}\}\)</span> according to the grouping variable <code>ID.group="region"</code>. The neighbourhood order to add polygons at the border of the spatial subdomains is controlled by the <code>k</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute subdomains for k=0,1 and 2</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>carto.k0 <span class="ot">&lt;-</span> <span class="fu">divide_carto</span>(<span class="at">carto=</span>Carto_SpainMUN, <span class="at">ID.group=</span><span class="st">"region"</span>, <span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>carto.k1 <span class="ot">&lt;-</span> <span class="fu">divide_carto</span>(<span class="at">carto=</span>Carto_SpainMUN, <span class="at">ID.group=</span><span class="st">"region"</span>, <span class="at">k=</span><span class="dv">1</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>carto.k2 <span class="ot">&lt;-</span> <span class="fu">divide_carto</span>(<span class="at">carto=</span>Carto_SpainMUN, <span class="at">ID.group=</span><span class="st">"region"</span>, <span class="at">k=</span><span class="dv">2</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot the spatial polygons for the autonomous region of Castilla y Leon </span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carto.k2<span class="sc">$</span><span class="st">`</span><span class="at">Castilla y Leon</span><span class="st">`</span><span class="sc">$</span>geometry, <span class="at">col=</span><span class="st">"dodgerblue4"</span>, <span class="at">main=</span><span class="st">"Castilla y Leon"</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carto.k1<span class="sc">$</span><span class="st">`</span><span class="at">Castilla y Leon</span><span class="st">`</span><span class="sc">$</span>geometry, <span class="at">col=</span><span class="st">"dodgerblue"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(carto.k0<span class="sc">$</span><span class="st">`</span><span class="at">Castilla y Leon</span><span class="st">`</span><span class="sc">$</span>geometry, <span class="at">col=</span><span class="st">"lightgrey"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Section2_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="compare-the-results" class="level3">
<h3 class="anchored" data-anchor-id="compare-the-results">Compare the results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Carto object of the Spanish provinces </span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>carto.CCAA <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(Carto_SpainMUN[,<span class="st">"geometry"</span>],<span class="fu">list</span>(<span class="at">ID.group=</span><span class="fu">st_drop_geometry</span>(Carto_SpainMUN)<span class="sc">$</span>region), head)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Model selection criteria</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>MODELS <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Global=</span>iCAR.Global, <span class="at">k0=</span>iCAR.k0, <span class="at">k1=</span>iCAR.k1, <span class="at">k2=</span>iCAR.k2)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="fu">do.call</span>(rbind,<span class="fu">lapply</span>(MODELS, compare.DIC))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       mean.deviance    p.eff      DIC     WAIC      time
Global      27087.61 342.1213 27429.73 27430.14  9.779073
k0          27101.43 344.7464 27446.18 27443.85 44.407377
k1          27098.38 333.5373 27431.92 27433.56 50.829343
k2          27132.04 307.2688 27439.31 27444.14 52.147860</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Maps with posterior median estimates of log-risks</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>Global <span class="ot">&lt;-</span> iCAR.Global<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0.5quant</span><span class="st">`</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>k0 <span class="ot">&lt;-</span> iCAR.k0<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0.5quant</span><span class="st">`</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>k1 <span class="ot">&lt;-</span> iCAR.k1<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0.5quant</span><span class="st">`</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>k2 <span class="ot">&lt;-</span> iCAR.k2<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0.5quant</span><span class="st">`</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>paleta <span class="ot">&lt;-</span> <span class="fu">brewer.pal</span>(<span class="dv">8</span>,<span class="st">"RdYlGn"</span>)[<span class="dv">8</span><span class="sc">:</span><span class="dv">1</span>]</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">0.83</span>,<span class="fl">0.91</span>,<span class="fl">0.95</span>,<span class="dv">1</span>,<span class="fl">1.05</span>,<span class="fl">1.10</span>,<span class="fl">1.20</span>)),<span class="cn">Inf</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>Map.risk <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(Carto_SpainMUN) <span class="sc">+</span> </span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col=</span><span class="fu">c</span>(<span class="st">"Global"</span>,<span class="st">"k0"</span>,<span class="st">"k1"</span>,<span class="st">"k2"</span>), <span class="at">palette=</span>paleta, <span class="at">border.alpha=</span><span class="dv">0</span>,</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">title=</span><span class="st">"log-risks"</span>, <span class="at">legend.show=</span>T, <span class="at">legend.reverse=</span>T,</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">style=</span><span class="st">"fixed"</span>, <span class="at">breaks=</span>values, <span class="at">interval.closure=</span><span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(carto.CCAA) <span class="sc">+</span> <span class="fu">tm_borders</span>(<span class="at">col=</span><span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title=</span><span class="st">"Posterior median estimates"</span>, <span class="at">main.title.position=</span><span class="st">"center"</span>,</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.labels=</span><span class="fu">c</span>(<span class="st">"Global model"</span>,<span class="st">"Disjoint model"</span>,<span class="st">"1st-order nb"</span>,<span class="st">"2nd-order nb"</span>),</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside=</span>T, <span class="at">legend.outside.position=</span><span class="st">"right"</span>, <span class="at">legend.frame=</span>F,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside.size=</span><span class="fl">0.2</span>, <span class="at">outer.margins=</span><span class="fu">c</span>(<span class="fl">0.02</span>,<span class="fl">0.01</span>,<span class="fl">0.02</span>,<span class="fl">0.01</span>)) <span class="sc">+</span> </span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Map.risk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Section2_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Maps with posterior exceedence probabilities</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>Global <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>iCAR.Global<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0cdf</span><span class="st">`</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>k0 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>iCAR.k0<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0cdf</span><span class="st">`</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>k1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>iCAR.k1<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0cdf</span><span class="st">`</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>k2 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>iCAR.k2<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span><span class="st">`</span><span class="at">0cdf</span><span class="st">`</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>paleta <span class="ot">&lt;-</span> <span class="fu">brewer.pal</span>(<span class="dv">6</span>,<span class="st">"Blues"</span>)[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.8</span>,<span class="fl">0.9</span>,<span class="dv">1</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>Map.prob <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(Carto_SpainMUN) <span class="sc">+</span> </span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col=</span><span class="fu">c</span>(<span class="st">"Global"</span>,<span class="st">"k0"</span>,<span class="st">"k1"</span>,<span class="st">"k2"</span>), <span class="at">palette=</span>paleta, <span class="at">border.alpha=</span><span class="dv">0</span>,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">title=</span><span class="st">"Prob"</span>, <span class="at">legend.show=</span>T, <span class="at">legend.reverse=</span>T,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">style=</span><span class="st">"fixed"</span>, <span class="at">breaks=</span>values, <span class="at">interval.closure=</span><span class="st">"left"</span>,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"[0-0.1)"</span>,<span class="st">"[0.1-0.2)"</span>,<span class="st">"[0.2-0.8)"</span>,<span class="st">"[0.8-0.9)"</span>,<span class="st">"[0.9-1]"</span>)) <span class="sc">+</span> </span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(carto.CCAA) <span class="sc">+</span> <span class="fu">tm_borders</span>(<span class="at">col=</span><span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title=</span><span class="st">"Posterior exceedence probabilities"</span>, <span class="at">main.title.position=</span><span class="st">"center"</span>,</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.labels=</span><span class="fu">c</span>(<span class="st">"Global model"</span>,<span class="st">"Disjoint model"</span>,<span class="st">"1st-order nb"</span>,<span class="st">"2nd-order nb"</span>),</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside=</span>T, <span class="at">legend.outside.position=</span><span class="st">"right"</span>, <span class="at">legend.frame=</span>F,</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside.size=</span><span class="fl">0.2</span>, <span class="at">outer.margins=</span><span class="fu">c</span>(<span class="fl">0.02</span>,<span class="fl">0.01</span>,<span class="fl">0.02</span>,<span class="fl">0.01</span>)) <span class="sc">+</span> </span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Map.prob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Section2_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="example-2-ecological-regression-model" class="level2">
<h2 class="anchored" data-anchor-id="example-2-ecological-regression-model">Example 2: ecological regression model</h2>
<p>In this second example, we are going to fit a spatial model that incorporates both area-level CAR random effects and a set of explanatory variables, with the aim of comparing the regression coefficient estimates obtained from the global and partitioned models.</p>
<p>For this, we will use the data contained in the <code>Data_MultiCancer</code> object as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Define the data and the spatial covariates ##</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Data_MultiCancer"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Data_MultiCancer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     ID disease obs        exp       SMR
1 01001       1   3  6.6147794 0.4535299
2 01002       1  41 42.6337564 0.9616793
3 01003       1   4  7.4307781 0.5383016
4 01004       1   6  6.3549654 0.9441436
5 01006       1   0  0.9337634 0.0000000
6 01008       1   2  3.9404795 0.5075524</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> Data_MultiCancer[Data_MultiCancer<span class="sc">$</span>disease<span class="sc">==</span><span class="dv">1</span>,]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>X1 <span class="ot">&lt;-</span> Data_MultiCancer[Data_MultiCancer<span class="sc">$</span>disease<span class="sc">==</span><span class="dv">2</span>,<span class="st">"SMR"</span>]</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>X2 <span class="ot">&lt;-</span> Data_MultiCancer[Data_MultiCancer<span class="sc">$</span>disease<span class="sc">==</span><span class="dv">3</span>,<span class="st">"SMR"</span>]</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     ID disease obs        exp       SMR        X1        X2
1 01001       1   3  6.6147794 0.4535299 1.3051895 0.7755112
2 01002       1  41 42.6337564 0.9616793 1.5158172 0.7053982
3 01003       1   4  7.4307781 0.5383016 1.0527138 1.3203218
4 01004       1   6  6.3549654 0.9441436 0.6153434 0.7681720
5 01006       1   0  0.9337634 0.0000000 0.0000000 0.0000000
6 01008       1   2  3.9404795 0.5075524 0.0000000 1.2496763</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Define the sf object ##</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>obs <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>exp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>Carto_SpainMUN<span class="sc">$</span>SMR <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>carto <span class="ot">&lt;-</span> <span class="fu">merge</span>(Carto_SpainMUN,data,<span class="at">by=</span><span class="st">"ID"</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(carto)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 15 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 485318 ymin: 4727428 xmax: 543317 ymax: 4779153
Projected CRS: ETRS89 / UTM zone 30N
     ID                                    name           area    perimeter
1 01001                        Alegria-Dulantzi 19913794 [m^2] 34372.11 [m]
2 01002                                 Amurrio 96145595 [m^2] 63352.32 [m]
3 01003                                 Aramaio 73338806 [m^2] 41430.46 [m]
4 01004                              Artziniega 27506468 [m^2] 22605.22 [m]
5 01006                                 Arminon 10559721 [m^2] 17847.35 [m]
6 01008 Arrazua-Ubarrundia (San Martin de Ania) 57502811 [m^2] 64968.81 [m]
      region    Global        k0        k1        k2 disease obs        exp
1 Pais Vasco 0.6978446 0.6703088 0.7527308 0.7508028       1   3  6.6147794
2 Pais Vasco 0.8803894 0.8694078 0.8576663 0.8654468       1  41 42.6337564
3 Pais Vasco 0.8397482 0.8311718 0.8486363 0.8489246       1   4  7.4307781
4 Pais Vasco 0.7516241 0.7511988 0.7720012 0.7331037       1   6  6.3549654
5 Pais Vasco 0.6473510 0.6001159 0.6230463 0.6358718       1   0  0.9337634
6 Pais Vasco 0.7165259 0.7041837 0.7359355 0.7344448       1   2  3.9404795
        SMR        X1        X2                       geometry
1 0.4535299 1.3051895 0.7755112 MULTIPOLYGON (((538259 4737...
2 0.9616793 1.5158172 0.7053982 MULTIPOLYGON (((503520 4760...
3 0.5383016 1.0527138 1.3203218 MULTIPOLYGON (((533286 4759...
4 0.9441436 0.6153434 0.7681720 MULTIPOLYGON (((491260 4776...
5 0.0000000 0.0000000 0.0000000 MULTIPOLYGON (((509851 4727...
6 0.5075524 0.0000000 1.2496763 MULTIPOLYGON (((534678 4746...</code></pre>
</div>
</div>
<p>A character vector with the covariate names or the design matrix of the fixed effects can be included through the <code>X=...</code> argument of the <code>CAR_INLA()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>iCAR.Global <span class="ot">&lt;-</span> <span class="fu">CAR_INLA</span>(<span class="at">carto=</span>carto, <span class="at">ID.area=</span><span class="st">"ID"</span>,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">O=</span><span class="st">"obs"</span>, <span class="at">E=</span><span class="st">"exp"</span>, <span class="at">X=</span><span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>),</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">model=</span><span class="st">"global"</span>, <span class="at">prior=</span><span class="st">"intrinsic"</span>, <span class="at">inla.mode=</span><span class="st">"compact"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>STEP 1: Pre-processing data
STEP 2: Fitting global model with INLA (this may take a while...)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>iCAR.k1 <span class="ot">&lt;-</span> <span class="fu">CAR_INLA</span>(<span class="at">carto=</span>carto, <span class="at">ID.area=</span><span class="st">"ID"</span>,</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">O=</span><span class="st">"obs"</span>, <span class="at">E=</span><span class="st">"exp"</span>, <span class="at">X=</span><span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">model=</span><span class="st">"partition"</span>, <span class="at">k=</span><span class="dv">1</span>, <span class="at">ID.group=</span><span class="st">"region"</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior=</span><span class="st">"intrinsic"</span>, <span class="at">inla.mode=</span><span class="st">"compact"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>STEP 1: Pre-processing data
STEP 2: Fitting partition (k=1) model with INLA 
+ Model 1 of 15 
+ Model 2 of 15 
+ Model 3 of 15 
+ Model 4 of 15 
+ Model 5 of 15 
+ Model 6 of 15 
+ Model 7 of 15 
+ Model 8 of 15 
+ Model 9 of 15 
+ Model 10 of 15 
+ Model 11 of 15 
+ Model 12 of 15 
+ Model 13 of 15 
+ Model 14 of 15 
+ Model 15 of 15 
STEP 3: Merging the results</code></pre>
</div>
</div>
<section id="local-and-global-estimates-of-the-fixed-effects" class="level3">
<h3 class="anchored" data-anchor-id="local-and-global-estimates-of-the-fixed-effects">Local and global estimates of the fixed effects</h3>
<p>Summary statistics of the posterior marginal estimates for the global model’s fixed effects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>iCAR.Global<span class="sc">$</span>summary.fixed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    mean          sd   0.025quant    0.5quant  0.975quant
(Intercept) -0.143431120 0.006025473 -0.155278872 -0.14341961 -0.13164882
X1           0.021959574 0.009970845  0.002396737  0.02196339  0.04150069
X2           0.001719766 0.010214449 -0.018316430  0.00172206  0.02174290
                    mode          kld
(Intercept) -0.143419533 1.017661e-09
X1           0.021963409 8.770457e-11
X2           0.001722071 6.288784e-11</code></pre>
</div>
</div>
<p>In partition models, local estimates of the fixed effects coefficients are obtained in each province:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^X1"</span>,<span class="fu">rownames</span>(iCAR.k1<span class="sc">$</span>summary.fixed.partition))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(iCAR.k1<span class="sc">$</span>summary.fixed.partition[x1,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         sd    0.025quant     0.5quant 0.975quant
X1.01  0.035030880 0.03127741 -0.0265000455  0.035098908 0.09617459
X1.02  0.062384460 0.03188713 -0.0001847692  0.062397567 0.12487918
X1.03 -0.147491362 0.08699741 -0.3208914254 -0.146539361 0.02048612
X1.04 -0.039189396 0.07361260 -0.1841407039 -0.039029497 0.10483569
X1.05  0.010311903 0.02926385 -0.0471797741  0.010348424 0.06759555
X1.06 -0.001755338 0.01857518 -0.0381982585 -0.001749027 0.03465168
              mode
X1.01  0.035099245
X1.02  0.062397663
X1.03 -0.146537606
X1.04 -0.039033871
X1.05  0.010348563
X1.06 -0.001748989</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^X2"</span>,<span class="fu">rownames</span>(iCAR.k1<span class="sc">$</span>summary.fixed.partition))</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(iCAR.k1<span class="sc">$</span>summary.fixed.partition[x2,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         sd  0.025quant     0.5quant  0.975quant         mode
X2.01  0.007483663 0.03192414 -0.05517454  0.007502554 0.070034332  0.007502651
X2.02 -0.063209201 0.03579666 -0.13345289 -0.063193311 0.006943974 -0.063193248
X2.03  0.063872631 0.07846802 -0.09169413  0.064418356 0.216323437  0.064416081
X2.04 -0.081429751 0.08111565 -0.24071884 -0.081386609 0.077617643 -0.081385473
X2.05 -0.006772546 0.02773751 -0.06123464 -0.006748671 0.047553713 -0.006748531
X2.06  0.007999922 0.01719930 -0.02572534  0.007999391 0.041728210  0.007999390</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Maps with posterior median estimates at each province</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>carto.CCAA <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(Carto_SpainMUN[,<span class="st">"geometry"</span>],<span class="fu">list</span>(<span class="at">ID.group=</span><span class="fu">st_drop_geometry</span>(Carto_SpainMUN)<span class="sc">$</span>region), head)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>carto.CCAA<span class="sc">$</span>X1 <span class="ot">&lt;-</span> iCAR.k1<span class="sc">$</span>summary.fixed.partition<span class="sc">$</span><span class="st">`</span><span class="at">0.5quant</span><span class="st">`</span>[x1]</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>carto.CCAA<span class="sc">$</span>X2 <span class="ot">&lt;-</span> iCAR.k1<span class="sc">$</span>summary.fixed.partition<span class="sc">$</span><span class="st">`</span><span class="at">0.5quant</span><span class="st">`</span>[x2]</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>paleta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">"Reds"</span>)[<span class="dv">3</span><span class="sc">:</span><span class="dv">2</span>],<span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">"Blues"</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.2</span>,<span class="fl">0.2</span>,<span class="fl">0.1</span>)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(carto.CCAA) <span class="sc">+</span> </span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col=</span><span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>), <span class="at">palette=</span>paleta,</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">title=</span><span class="st">""</span>, <span class="at">legend.show=</span>T, <span class="at">legend.reverse=</span>T,</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">style=</span><span class="st">"fixed"</span>, <span class="at">breaks=</span>values, <span class="at">interval.closure=</span><span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title=</span><span class="st">"Posterior median estimates"</span>, <span class="at">main.title.position=</span><span class="st">"center"</span>,</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside=</span>T, <span class="at">legend.outside.position=</span><span class="st">"right"</span>, <span class="at">legend.frame=</span>F,</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.labels=</span><span class="fu">c</span>(<span class="st">"X1 covariate"</span>,<span class="st">"X2 covariate"</span>),</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside.size=</span><span class="fl">0.2</span>, <span class="at">outer.margins=</span><span class="fu">c</span>(<span class="fl">0.02</span>,<span class="fl">0.01</span>,<span class="fl">0.02</span>,<span class="fl">0.01</span>)) <span class="sc">+</span> </span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">nrow=</span><span class="dv">1</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Section2_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Global estimates can be also computed by combining the marginal estimates in each partition by applying the CMC algorithm:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">Global=</span>iCAR.Global<span class="sc">$</span>summary.fixed[<span class="st">"X1"</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">k1-CMC</span><span class="st">`</span><span class="ot">=</span>iCAR.k1<span class="sc">$</span>summary.fixed[<span class="st">"X1"</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             mean          sd   0.025quant   0.5quant 0.975quant
Global 0.02195957 0.009970845 0.0023967366 0.02196339 0.04150069
k1-CMC 0.01907377 0.009416197 0.0008899967 0.01900037 0.03755495</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">Global=</span>iCAR.Global<span class="sc">$</span>summary.fixed[<span class="st">"X2"</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">k1-CMC</span><span class="st">`</span><span class="ot">=</span>iCAR.k1<span class="sc">$</span>summary.fixed[<span class="st">"X2"</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               mean          sd  0.025quant    0.5quant 0.975quant
Global  0.001719766 0.010214449 -0.01831643  0.00172206 0.02174290
k1-CMC -0.005786529 0.009814363 -0.02515914 -0.00583585 0.01349537</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="Section2_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="960"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



</body></html>